---
title: "HSCI410WOrk"
author: "Mark Ly"
date: "11/19/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
library(dplyr)
library(ggplot2)

#33 variables 109659 individuals
depdata <- dplyr::select(x, ADM_RNO, DODEP, DOWST, DEPDVSEV,GEN_015,GEN_020, GEN_025,LBFDGHPW,LBFDVPFT,LBFDGOCG,CCC_195,CCC_200,GEO_PRV,DHH_SEX,DHHGMS,DHHGAGE,SDCDGCGT,GENDVHDI,GENDVMHI,INCDGPER,INCDGHH,SWL_005,SWL_015,ALCDVTTM,ALC_015,SMK_005,SMKDVSTY,HWTDGISW,WST_035,SLP_015,EHG2DVR3,SACDVTER,SUI_010)



#Recoding data from strings to numerical ranks from 0-1,9 is used to combine those who answered "Not stated" or "Valid skip"
scale1 <- function(x){
  case_when(x %in% c("Poor")~0,
            x %in% c("Fair")~1,
            x %in% c("Good")~2,
            x %in% c("Very good")~3,
            x %in% c("Excellent")~4,
            x %in% c("Don't know")~9,
            x %in% c("Refusal")~9,
            x %in% c("Not stated")~9)
}
scale2 <- function(x){
  case_when(x %in% c("Married")~0,
            x %in% c("Common-law")~1,
            x %in% c("Widowed/Divorced/Separated")~2,
            x %in% c("Single")~3,
            x %in% c("Not stated")~9)
}

scale3 <- function(x){
  case_when(x %in% c("No depression")~0,
            x %in% c("Minimal depression")~1,
            x %in% c("Mild depression")~2,
            x %in% c("Moderate depression")~3,
            x %in% c("Moderately severe depression")~4,
            x %in% c("Severe depression")~5,
            x %in% c("Valid skip")~9,
            x %in% c("Not stated")~9)
}

scale4 <- function(x){
  case_when(x %in% c("Full-time")~0,
            x %in% c("Part-time")~1,
            x %in% c("Valid skip")~9,
            x %in% c("Not stated")~9)
}

scale5 <- function(x){
  case_when(x %in% c("No income or income loss")~0,
            x %in% c("Less than $20,000")~1,
            x %in% c("$20,000 to $39,999")~2,
            x %in% c("$40,000 to $59,999")~3,
            x %in% c("$60,000 to $79,999")~4,
            x %in% c("$80,000 or more")~5,
            x %in% c("Valid skip")~9,
            x %in% c("Not stated")~9)
}

scale6 <- function(x){
  case_when(x %in% c("Not at all satisfied")~0,
            x %in% c("Not too satisfied")~1,
            x %in% c("Somewhat satisfied")~2,
            x %in% c("Very satisfied")~3,
            x %in% c("Valid skip")~9,
            x %in% c("Don’t know")~9,
            x %in% c("Refusal")~9,
            x %in% c("Not stated")~9)

}

scale7 <- function(x){
  case_when(x %in% c("Not at all stressful")~0,
            x %in% c("Not very stressful")~1,
            x %in% c("A bit stressful")~2,
            x %in% c("Quite a bit stressful")~3,
            x %in% c("Extremely stressful")~4,
            x %in% c("Don’t know")~9,
            x %in% c("Refusal")~9,
            x %in% c("Valid skip")~9,
            x %in% c("Not stated")~9)
            
}

scale8 <- function(x){
  case_when(x %in% c("Strongly disagree")~0,
            x %in% c("Disagree")~1,
            x %in% c("Neither agree nor disagree")~2,
            x %in% c("Agree")~3,
            x %in% c("Strongly agree")~4,
            x %in% c("Valid skip")~9,
            x %in% c("Don’t know")~9,
            x %in% c("Not applicable")~9,
            x %in% c("Refusal")~9,
            x %in% c("Not stated")~9)
}

scale9<- function(x){
  case_when(x %in% c("Yes")~1,
            x %in% c("No")~0)
}

scale10 <- function(x){
  case_when(x %in% c("No income or less than $20,000")~0,
            x %in% c("$20,000 to $39,999")~1,
            x %in% c("$40,000 to $59,999")~2,
            x %in% c("$60,000 to $79,999")~3,
            x %in% c("$80,000 or more")~4,
            x %in% c("Not stated")~9)
}

scale11<- function(x){
  case_when(x %in% c("Very dissatisfied")~0,
            x %in% c("Dissatisfied")~1,
            x %in% c("Neither satisfied nor dissatisfied")~2,
            x %in% c("Satisfied")~3,
            x %in% c("Very satisfied")~4,
            x %in% c("Valid skip")~9,
            x %in% c("Refusal")~9,
            x %in% c("Not stated")~9,
            x %in% c("Don’t know")~9)
}

scale12<- function(x){
  case_when(x %in% c("Female")~0,
            x %in% c("Male")~1)
}

scale13<- function(x){
  case_when(x %in% c("BRITISH COLUMBIA")~0,
            x %in% c("ALBERTA")~1,
            x %in% c("SASKATCHEWAN")~2,
            x %in% c("MANITOBA")~3,
            x %in% c("ONTARIO")~4,
            x %in% c("QUEBEC")~5,
            x %in% c("NEW BRUNSWICK")~6,
            x %in% c("NOVA SCOTIA")~7,
            x %in% c("PRINCE EDWARD ISLAND")~8,
            x %in% c("NEWFOUNDLAND AND LABRADOR")~9,
            x %in% c("YUKON")~10,
            x %in% c("NUNAVUT")~11,
            x %in% c("NORTHWEST TERRITORIES")~12)
}

scale14<- function(x){
  case_when(x %in% c("Age between 12 and 14")~0,
            x %in% c("Age between 15 and 17")~1,
            x %in% c("Age between 18 and 19")~2,
            x %in% c("Age between 20 and 24")~3,
            x %in% c("Age between 25 and 29")~4,
            x %in% c("Age between 30 and 34")~5,
            x %in% c("Age between 35 and 39")~6,
            x %in% c("Age between 40 and 44")~7,
            x %in% c("Age between 45 and 49")~8,
            x %in% c("Age between 50 and 54")~9,
            x %in% c("Age between 55 and 59")~10,
            x %in% c("Age between 60 and 64")~11,
            x %in% c("Age between 65 and 69")~12,
            x %in% c("Age between 70 and 74")~13,
            x %in% c("Age between 75 and 79")~14,
            x %in% c("Age 80 and older")~15)
}

scale15<- function(x){
  case_when(x %in% c("[0-30)")~0,
            x %in% c("[30-40)")~1,
            x %in% c("[40-99)")~2)
}

scale16<- function(x){
  case_when(x %in% c("White")~0,
            x %in% c("Non-white (Aboriginal or Other Visible Minority)")~1,
            x %in% c("Valid skip")~9,
            x %in% c("Not stated")~9)
}

scale17<- function(x){
  case_when(x %in% c("Yes")~0,
            x %in% c("No")~1,
            x %in% c("Don't know")~9,
            x %in% c("Valid skip")~9,
            x %in% c("Not stated")~9)
}

scale19<- function(x){
  case_when(x %in% c("White")~0,
            x %in% c("Non-white (Aboriginal or Other Visible Minority)")~1)
}

scale20 <- function(x){
  case_when(x %in% c("Full-time")~0,
            x %in% c("Part-time")~1)
}

scale21<- function(x){
  case_when(x %in% c("NOC Code first digit: 1, 3, 4, 5, 6")~0,
            x %in% c("NOC Code first digit: 2")~1,
            x %in% c("NOC Code first digit: 6")~2,
            x %in% c("NOC Code first digit: 7")~3,
            x %in% c("NOC Code first digit: 8, 9")~4,
            x %in% c("Valid skip")~9,
            x %in% c("Not stated")~9)
}

scale22 <- function(x){
  case_when(x %in% c("Occasional drinker")~0,
            x %in% c("Regular drinker")~1)
}

scale23 <- function(x){
  case_when(x %in% c("Less than once a month")~0,
            x %in% c("Once a month")~1,
            x %in% c("2 to 3 times a month")~2,
            x %in% c("Once a week")~3,
            x %in% c("2 to 3 times a week")~4,
            x %in% c("4 to 6 times a week")~5,
            x %in% c("Every day")~6)
}

scale24<- function(x){
  case_when(x %in% c("Lifetime abstainer (never smoked a whole cigarette)")~0,
            x %in% c("Experimental smoker (at least 1 cig, non-smoker now)")~1,
            x %in% c("Former occasional smoker (non-smoker now)")~2,
            x %in% c("Former daily smoker (non-smoker now)")~3,
            x %in% c("Current occasional smoker")~4,
            x %in% c("Current daily smoker")~5,
            x %in% c("Not stated")~9)
}

scale25<- function(x){
  case_when(x %in% c("Normal weight")~0,
            x %in% c("Underweight")~1,
            x %in% c("Overweight")~2,
            x %in% c("Obese - Class I, II, III")~3,
            x %in% c("Not stated")~9)
}

scale26<- function(x){
  case_when(x %in% c("Never")~0,
            x %in% c("Rarely")~1,
            x %in% c("Sometimes")~2,
            x %in% c("Most of the time")~3,
            x %in% c("Sometimes")~4,
            x %in% c("All of the time")~5,
            x %in% c("Valid skip")~9,
            x %in% c("Not stated")~9)
}

scale27<- function(x){
  case_when(x %in% c("Less than secondary school graduation")~0,
            x %in% c("Secondary school graduation, no post-secondary education")~1,
            x %in% c("Post-secondary certificate diploma or univ degree")~2,
            x %in% c("Not stated")~9)
}

scale28<- function(x){
  case_when(x %in% c("Not at all")~0,
            x %in% c("Occasionally")~1,
            x %in% c("Daily")~2)
}


#Apply scale to data
depdata$DODEP <- sapply(depdata$DODEP,scale9)
depdata$DOWST<- sapply(depdata$DOWST, scale9)

#Filtering out data
#33 columns 54992 selecting only those that report working hours.
depdata.hours <- depdata %>%
  filter(!LBFDGHPW %in% c("Not stated","Valid skip"))
depdata.hours$LBFDGHPW <- as.numeric(depdata.hours$LBFDGHPW)

#Filter out responses that are not stated #41179
depdata1 <- depdata.hours %>%
  filter(!LBFDGOCG %in% c("Not stated"),
         !INCDGHH %in% c("Not stated"),
         !EHG2DVR3 %in% c("Not stated"),
         !ALCDVTTM %in% c("Not stated"),
         !SDCDGCGT %in% c("Not stated", "Valid skip"),
         #!DEPDVSEV %in% c("Not stated", "Valid skip"),
         !GEN_015 %in% c("Not stated", "Don't know","Refusal"),
         !GEN_020 %in% c("Not stated", "Don't know","Refusal"),
         !GEN_025 %in% c("Not stated", "Don't know","Refusal"),
         !DHHGMS %in% c("Not stated"),
         !CCC_195 %in% c("Don't know", "Refusal"),
         !CCC_200 %in% c("Don't know", "Refusal"),
         !GENDVHDI %in% c("Not stated"),
         !GENDVMHI %in% c("Not stated"),
         !INCDGPER %in% c("Valid skip","Not stated"),
         #!SWL_005 %in% c("Valid skip", "Don't know","Refusal","Not stated"),
         #!SWL_015 %in% c("Valid skip", "Don't know","Refusal","Not stated"),
         !ALC_015 %in% c("Valid skip"),
         !HWTDGISW %in% c("Valid skip", "Not stated"),
         !SMKDVSTY %in% c("Not stated"))
         

#Renaming and working using this data set. This data set has individuals aged from 18-64. It has 38993 participants. Work satisfaction and job security not filtered out in this data set as >45000 individuals would have been dropped. A separate analysis will be done after filtering out those variables.
depdata18to64 <- depdata1 %>%
  filter(!DHHGAGE %in% c("Age between 65 and 69","Age between 70 and 74"))

#Converting working data set string data to numerical data using scales for analysis.

#depdata18to64$DEPDVSEV <- sapply(depdata18to64$DEPDVSEV,scale3)
depdata18to64$GEN_015 <- sapply(depdata18to64$GEN_015,scale1)
depdata18to64$GEN_020 <- sapply(depdata18to64$GEN_020,scale7)
depdata18to64$GEN_025 <- sapply(depdata18to64$GEN_025,scale7)
depdata18to64$LBFDVPFT <- sapply(depdata18to64$LBFDVPFT,scale20)
depdata18to64$LBFDGOCG <- sapply(depdata18to64$LBFDGOCG,scale21)
depdata18to64$CCC_dim195 <- sapply(depdata18to64$CCC_195,scale9)
depdata18to64$CCC_200 <- sapply(depdata18to64$CCC_200,scale9)
depdata18to64$GEO_PRV <- sapply(depdata18to64$GEO_PRV,scale13)
depdata18to64$DHH_SEX <- sapply(depdata18to64$DHH_SEX,scale12)
depdata18to64$DHHGMS <- sapply(depdata18to64$DHHGMS, scale2)

depdata18to64$SDCDGCGT <- sapply(depdata18to64$SDCDGCGT,scale19)
depdata18to64$GENDVHDI <- sapply(depdata18to64$GENDVHDI,scale1)
depdata18to64$GENDVMHI <- sapply(depdata18to64$GENDVMHI,scale1)
depdata18to64$INCDGPER <- sapply(depdata18to64$INCDGPER,scale5)
depdata18to64$INCDGHH <- sapply(depdata18to64$INCDGHH,scale10)

depdata18to64$ALCDVTTM <- sapply(depdata18to64$ALCDVTTM,scale22)
depdata18to64$ALC_015 <- sapply(depdata18to64$ALC_015,scale23)
depdata18to64$SMK_005 <- sapply(depdata18to64$SMK_005,scale28)
depdata18to64$SMKDVSTY <- sapply(depdata18to64$SMKDVSTY,scale24)
depdata18to64$HWTDGISW <- sapply(depdata18to64$HWTDGISW,scale25)
depdata18to64$EHG2DVR3 <- sapply(depdata18to64$EHG2DVR3,scale27)


#Which age grouping to use? 18-25 25-40 40-65. unable to. [18-29] = 7606 [30-49] = 18382 [50-69] = 12707

agebracket <- c("[18-29]","[30-49]","[50-69]")

depdata18to64.test <- depdata18to64 %>%
  mutate(agebracket = case_when(
    DHHGAGE %in% c("Age between 18 and 19")~agebracket[1],
    DHHGAGE %in% c("Age between 20 and 24")~agebracket[1],
    DHHGAGE %in% c("Age between 25 and 29")~agebracket[1],
    DHHGAGE %in% c("Age between 30 and 34")~agebracket[2],
    DHHGAGE %in% c("Age between 35 and 39")~agebracket[2],
    DHHGAGE %in% c("Age between 40 and 44")~agebracket[2],
    DHHGAGE %in% c("Age between 45 and 49")~agebracket[2],
    DHHGAGE %in% c("Age between 50 and 54")~agebracket[3],
    DHHGAGE %in% c("Age between 55 and 59")~agebracket[3],
    DHHGAGE %in% c("Age between 60 and 64")~agebracket[3],
    DHHGAGE %in% c("Age between 65 and 69")~agebracket[3]))

depdata18to64.test$agebracket <- factor(depdata18to64.test$agebracket,
                                          levels = agebracket,
                                          ordered = FALSE)


#adding extra data to data set
#deprace <- dplyr::select(x, ADM_RNO, SDCDGCGT)
#depdata <- left_join(depdata, deprace, by ="ADM_RNO")





```

```{r}
library(kableExtra)
library(pixiedust)
library(MASS)

#Creating factors to for data analysis
#factor.dep.severity <- factor(depdata18to64.factor$DEPDVSEV, levels = c(0,1,2,3,4,5))
factor.mentalhealth <- factor(depdata18to64.test$GEN_015, levels= c(0,1,2,3,4))
factor.lifestress <- factor(depdata18to64.test$GEN_020, levels= c(0,1,2,3,4))
factor.workstress <- factor(depdata18to64.test$GEN_025, levels= c(0,1,2,3,4))
factor.worktype <- factor(depdata18to64.test$LBFDGOCG, levels = c(0,1,2,3,4))
factor.location <- factor(depdata18to64.test$GEO_PRV, levels = c(0,1,2,3,4,5,6,7,8,9,10,11,12))
factor.martial <- factor(depdata18to64.test$DHHGMS, levels = c(0,1,2,3))
factor.perceivedhealth <- factor(depdata18to64.test$GENDVHDI, levels = c(0,1,2,3,4))
factor.perceivedmenhealth <- factor(depdata18to64.test$GENDVMHI, levels = c(0,1,2,3,4))
factor.incomepersonal <- factor(depdata18to64.test$INCDGPER, levels = c(0,1,2,3,4,5))
factor.incomehousehold <- factor(depdata18to64.test$INCDGHH, levels = c(0,1,2,3,4))
factor.alcfreq <- factor(depdata18to64.test$ALC_015, levels = c(0,1,2,3,4,5,6))
factor.smkrtype <-factor(depdata18to64.test$SMK_005, levels = c(0,1,2))
factor.smkstatus <- factor(depdata18to64.test$SMKDVSTY, levels = c(0,1,2,3,4,5))
factor.bmi <- factor(depdata18to64.test$HWTDGISW, levels = c(0,1,2,3))
factor.edu <- factor(depdata18to64.test$EHG2DVR3, levels = c(0,1,2))
factor.race <- factor(depdata18to64.test$SDCDGCGT, levels = c(0,1))

#Work satisfaction 

#Logistic regression looking at workstress and work hours (for 1 hour increase)
dep.wrkhours <- glm(depdata18to64.factor$DODEP ~ depdata18to64.factor$LBFDGHPW, family = "binomial")
exp(dep.wrkhours$coefficients)

#Forward stepwise regression to determine variables to add 
full <- glm(depdata18to64.factor$DODEP ~ depdata18to64.factor$LBFDGHPW, family = "binomial")

null <- glm(depdata18to64.factor$DODEP ~ 1, family ='binomial')


step(null, scope = list(lower=null, upper= full), direction="forward")

#Tables for export
tgroup%>%
  rename(Depression_Status = DODEP)

fit <- glm(depdata.hours$DODEP ~ depdata.hours$DOWST, family = "binomial")

fit3 <- glm(depdata.race$DODEP ~ depdata.race$SDCDGCGT, family ="binomial")
fit4 <- glm(depdata.race$DOWST ~ depdata.race$SDCDGCGT, family ="binomial")


fit5<- glm(depdata.hours$DODEP ~ depdata.hours$LBFDGHPW, family = 'binomial')
fit6<- glm(depdata.hours$DOWST ~ depdata.hours$LBFDGHPW, family = 'binomial')
glm(depdata.type$DODEP ~ depdata.type$LBFDVPFT, family = 'binomial')


#not significant Depression and Sex
#glm(depdata.sex$DODEP ~ depdata.sex$DHH_SEX, family = 'binomial')
#glm(depdata.sex$DOWST ~ depdata.sex$DHH_SEX, family = 'binomial')



#depression and workstress
dust(fit) %>%
  sprinkle(col = 2:4, round = 3) %>%
  sprinkle(col = 5, fn= quote(pvalString(value))) %>%
  sprinkle_colnames(term = "Term",
                    estimate = "Estimate",
                    std.error = "SE",
                    statistic = "Z-Statistic",
                    p.value= "P-value") %>%
  kable()%>%
  kable_paper("striped",full_width = TRUE)

#Depression and background
dust(fit3) %>%
  sprinkle(col = 2:4, round = 3) %>%
  sprinkle(col = 5, fn= quote(pvalString(value))) %>%
  sprinkle_colnames(term = "Term",
                    estimate = "Estimate",
                    std.error = "SE",
                    statistic = "Z-Statistic",
                    p.value= "P-value") %>%
  kable()%>%
  kable_paper("striped",full_width = TRUE)

#Workstress and background
dust(fit4) %>%
  sprinkle(col = 2:4, round = 3) %>%
  sprinkle(col = 5, fn= quote(pvalString(value))) %>%
  sprinkle_colnames(term = "Term",
                    estimate = "Estimate",
                    std.error = "SE",
                    statistic = "Z-Statistic",
                    p.value= "P-value") %>%
  kable()%>%
  kable_paper("striped",full_width = TRUE)

#Depression and Work hours
dust(fit5) %>%
  sprinkle(col = 2:4, round = 3) %>%
  sprinkle(col = 5, fn= quote(pvalString(value))) %>%
  sprinkle_colnames(term = "Term",
                    estimate = "Estimate",
                    std.error = "SE",
                    statistic = "Z-Statistic",
                    p.value= "P-value") %>%
  kable()%>%
  kable_paper("striped",full_width = TRUE)

#Workstress and Work hours
dust(fit6) %>%
  sprinkle(col = 2:4, round = 3) %>%
  sprinkle(col = 5, fn= quote(pvalString(value))) %>%
  sprinkle_colnames(term = "Term",
                    estimate = "Estimate",
                    std.error = "SE",
                    statistic = "Z-Statistic",
                    p.value= "P-value") %>%
  kable()%>%
  kable_paper("striped",full_width = TRUE)

#Workstress and Hours 
dust(fit7) %>%
  sprinkle(col = 2:4, round = 3) %>%
  sprinkle(col = 5, fn= quote(pvalString(value))) %>%
  sprinkle_colnames(term = "Term",
                    estimate = "Estimate",
                    std.error = "SE",
                    statistic = "Z-Statistic",
                    p.value= "P-value") %>%
  kable()%>%
  kable_paper("striped",full_width = TRUE)

```

```{r}

#Frequency tables 

library(sjPlot)
library(sjmisc)
library(sjlabelled)

library(ggiraph)
library(ggiraphExtra)

ggPredict(fit5,se=TRUE,interactive=TRUE,digits=3)





```

